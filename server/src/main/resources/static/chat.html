<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WebRTC Conference Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="style.css" rel="stylesheet">
    <script src="adapter.js"></script>
    <script src="chatclient.js"></script>
</head>
<body>

<div id="login-page">
    <h2>Enter your username</h2>
    <input id="name" type="text" maxlength="12" required placeholder="Username">
    <button onclick="login()">Login</button>
</div>

<div id="conference-page" class="hidden">
    <div id="video-section">
        <div id="main-speaker">
            <video id="received_video" autoplay playsinline>Received video</video>
        </div>
        <div id="other-participants">
            <video id="local_video" autoplay muted playsinline>Local video</video>
            <!-- åŠ¨æ€æ·»åŠ æ›´å¤š participant çª—å£ -->
        </div>
    </div>

    <div id="bottom-menu">
<!--        <ul class="userlistbox"></ul>-->
<!--        <input type="button" id="send" name="send" value="Send" onclick="handleSendButton()" disabled>-->

        <button onclick="toggleMute()">ğŸ¤ Mute</button>
        <button onclick="toggleCamera()">ğŸ¥ Video</button>
        <button onclick="shareScreen()">ğŸ–¥ï¸ Share Screen</button>
        <button onclick="invite()">ğŸ“¨ Invite</button>
        <button onclick="toggleChat()">ğŸ’¬ Chat</button>
        <button onclick="toggleMemberList()">ğŸ‘¥ Members</button>
        <button onclick="startRecording()">âºï¸ Record</button>
        <button onclick="hangUpCall()">âŒ Hang Up</button>
    </div>

    <div id="sidebar" class="hidden">
        <div id="chatbox"   class="chatbox hidden">
            <h3>Chat</h3>
            <div id="chat-messages"></div>
            <input id="text" type="text" placeholder="Type a message..." onkeyup="handleKey(event)">
<!--            <input type="button" id="send" name="send" value="Send" onclick="handleSendButton()" disabled>-->

            <button id="send" onclick="handleSendButton()">Send</button>
        </div>

        <div id="memberlist" class="hidden">
            <h3>Members</h3>
            <ul id="userlist" class ="userlistbox"></ul>
        </div>
    </div>
</div>

<script>
    let localStream = null;
    let screenStream = null;
    let isCameraOn = true;
    let isSharingScreen = false;
    // ç™»å½•é€»è¾‘
    function login() {
            const username = document.getElementById('name').value.trim();
            if (!username) {
                alert('Username is required!');
                return;
            }
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('conference-page').classList.remove('hidden');

            connect(); // è°ƒç”¨ ç™»å½•
        }

    function toggleChat() {
        const sidebar = document.getElementById('sidebar');
        const chatbox = document.getElementById('chatbox');
        const memberlist = document.getElementById('memberlist');

        // æ˜¾ç¤º sidebar
        sidebar.style.display = 'block';
        chatbox.classList.toggle('hidden');

        // éšè—æˆå‘˜åˆ—è¡¨
        memberlist.classList.add('hidden');

        // å¦‚æœèŠå¤©å’Œæˆå‘˜éƒ½éšè—äº†ï¼Œåˆ™ sidebar å½»åº•æ¶ˆå¤±
        checkSidebar();
    }

        function toggleMemberList() {
            const sidebar = document.getElementById('sidebar');
            const memberlist = document.getElementById('memberlist');
            const chatbox = document.getElementById('chatbox');

            // æ˜¾ç¤º sidebar
            sidebar.style.display = 'block';
            memberlist.classList.toggle('hidden');

            // éšè—èŠå¤©æ¡†
            chatbox.classList.add('hidden');

<!--            if (!memberlist.classList.contains('hidden')) {-->
<!--                refreshUserList(); // æ›´æ–°æˆå‘˜åˆ—è¡¨-->
<!--            }-->

            // å¦‚æœèŠå¤©å’Œæˆå‘˜éƒ½éšè—äº†ï¼Œåˆ™ sidebar å½»åº•æ¶ˆå¤±
            checkSidebar();
        }

        // æ£€æŸ¥ sidebar æ˜¯å¦è¯¥éšè—
        function checkSidebar() {
            const sidebar = document.getElementById('sidebar');
            const chatbox = document.getElementById('chatbox');
            const memberlist = document.getElementById('memberlist');

            if (chatbox.classList.contains('hidden') && memberlist.classList.contains('hidden')) {
                sidebar.style.display = 'none'; // å½»åº•éšè—
            }
        }

         // åˆ·æ–°æˆå‘˜åˆ—è¡¨
        function refreshUserList() {
            const userlist = document.getElementById('userlist');
            userlist.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

            // å‡è®¾ allUsers å­˜å‚¨åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            if (typeof allUsers !== 'undefined' && Array.isArray(allUsers)) {
                // éå†ç”¨æˆ·åˆ—è¡¨
                allUsers.forEach(username => {
                    const li = document.createElement('li');
                    li.textContent = username;

                    // ä¸ºå½“å‰ç”¨æˆ·ï¼ˆè‡ªå·±ï¼‰æ·»åŠ ç‰¹æ®Šæ ·å¼
                    if (username === document.getElementById('name').value.trim()) {
                        li.classList.add('you');
                    }

                    userlist.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No users online';
                userlist.appendChild(li);
            }
        }


        // ä»¥ä¸‹æ˜¯æŒ‰é’®å¯¹åº”çš„åŸºç¡€åŠ¨ä½œï¼ˆåªæ˜¯ç®€å•ç¤ºä¾‹ï¼Œå¯ä»¥ç»“åˆchatclient.jså®é™…å®Œå–„ï¼‰
        function toggleMute() {
          console.log("Toggling mute...");
        }

        // åˆ‡æ¢æ‘„åƒå¤´å¼€å…³
        async function toggleCamera() {
            if (!localStream) {
                await startCamera();
                isCameraOn = true;
                return;
            }

            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack.enabled) {
                videoTrack.enabled = false;
                isCameraOn = false;
            } else {
                videoTrack.enabled = true;
                isCameraOn = true;
            }
        }

            // å¼€å§‹å±å¹•å…±äº«
        async function shareScreen() {
            if (isSharingScreen) {
                // åœæ­¢å…±äº«ï¼Œæ¢å¤æ‘„åƒå¤´
                const videoTrack = localStream.getVideoTracks()[0];
                const sender = myPeerConnection.getSenders().find(s => s.track.kind === 'video');
                if (sender) {
                    sender.replaceTrack(videoTrack);
                }
                const localVideo = document.getElementById('local_video');
                localVideo.srcObject = localStream;

                isSharingScreen = false;
            } else {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    const localVideo = document.getElementById('local_video');
                    localVideo.srcObject = screenStream;
                    // myPeerConnection å¦‚æœä¸ºç©ºå°± ä¸ç”¨ å…±äº«æœ¬åœ°
                    if (myPeerConnection) {
                        const sender = myPeerConnection.getSenders().find(s => s.track.kind === 'video');
                        if (sender) {
                            sender.replaceTrack(screenTrack);
                        }
                    }
<!--                    const sender = myPeerConnection.getSenders().find(s => s.track.kind === 'video');-->
<!--                    if (sender) {-->
<!--                        sender.replaceTrack(screenTrack);-->
<!--                    }-->



                    // ç›‘å¬åœæ­¢å…±äº«äº‹ä»¶
                    screenTrack.onended = () => {
                        shareScreen(); // è‡ªåŠ¨æ¢å¤æ‘„åƒå¤´
                    };

                    isSharingScreen = true;
                } catch (e) {
                    console.error('Error sharing screen', e);
                }
            }
        }

<!--        function invite() {-->
<!--          const inviteLink = window.location.href;-->
<!--          navigator.clipboard.writeText(inviteLink);-->
<!--          alert("Invitation link copied to clipboard!");-->
<!--        }-->

        function startRecording() {
          console.log("Starting recording...");
        }
        function hangUpCall() {
          console.log("Hanging up...");
        }


    // å¯ç”¨æœ¬åœ°æ‘„åƒå¤´æµ
    async function startCamera() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            const localVideo = document.getElementById('local_video');
            localVideo.srcObject = localStream;

            // å¦‚æœæœ‰Peerè¿æ¥ï¼Œæ›¿æ¢è§†é¢‘è½¨é“
            if (myPeerConnection) {
                const videoTrack = localStream.getVideoTracks()[0];
                const sender = myPeerConnection.getSenders().find(s => s.track.kind === 'video');
                if (sender) {
                    sender.replaceTrack(videoTrack);
                }
            }
        } catch (e) {
            console.error('Error accessing camera', e);
        }
    }
</script>

<style>
    /* ä¸´æ—¶æ”¾ä¸€ç‰ˆç®€æ´ç‰ˆCSSï¼Œstyle.cssé‡Œä¹Ÿå¯ä»¥åˆ†å‡ºå» */
    .hidden { display: none; }
    #video-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
    }
    #main-speaker {
      flex: 2;
      background-color: black;
      position: relative;
    }
    #main-speaker video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #other-participants {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    #other-participants video {
      width: 100px;
      height: 75px;
      object-fit: cover;
      background-color: black;
    }
    #bottom-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #333;
      padding: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    #bottom-menu button {
      background: #555;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
    }
    #bottom-menu button:hover {
      background: #777;
    }
    #sidebar {
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      width: 300px;
      background: #f0f0f0;
      overflow-y: auto;
      padding: 10px;
    }
    /* æˆå‘˜åˆ—è¡¨æ ·å¼ */
    #userlist li {
        background-color: #f0f0f0; /* æ›´æ¸©å’Œçš„èƒŒæ™¯è‰² */
        color: #333; /* ç™½è‰²å­—ä½“ */
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 5px;
        font-size: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #userlist li.you {
        background-color: #4caf50; /* è‡ªå·±çš„ç”¨æˆ·åèƒŒæ™¯è‰²ä¸ºç»¿è‰² */
        color: white; /* è‡ªå·±çš„ç”¨æˆ·åæ–‡å­—ä¸ºç™½è‰² */
        font-weight: bold; /* è‡ªå·±çš„åå­—åŠ ç²— */
    }

</style>

</body>
</html>

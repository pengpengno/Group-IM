# 用户登录与获取生命周期分析 (2025 更新版)

## 1. 概述

本文档详细分析了 Group IM 应用中用户从启动、登录、状态维护到注销的完整生命周期。该系统采用 **MVI + Repository** 架构，确保状态的单一数据源和数据流的可预测性。

## 2. 核心组件角色

- **UserViewModel**: UI 交互层。负责触发登录/自动登录/登出动作，并暴露 `loginState` 给 Compose UI。
- **UserRepository**: 业务逻辑与状态中心。持有 `userState (Flow)`，是应用中用户状态的 **唯一事实来源 (Single Source of Truth)**。
- **LoginStateManager**: 事件分发器。采用观察者模式，当用户状态变更时通知如 TCP Socket、消息同步等模块进行初始化或清理。
- **GlobalCredentialProvider**: 存储层桥梁。管理持久化的 Token 和 UserInfo。

## 3. 用户生命周期流程图

### 3.1 自动登录流程 (App 启动)
1. **[ViewModel] `autoLogin()`**: 启动协程。
2. **[Repository] `updateToChecking()`**: `userState` -> `Checking`。
3. **[Storage] `getUserInfo()`**: 检查本地是否有 `refreshToken`。
4. **状态分歧**:
   - **无凭据**: 调用 `updateToLoggedOut()` -> `userState` -> `Idle` (跳转登录页)。
   - **有凭据**: 调用 `updateToAuthenticating()` -> `userState` -> `Authenticating`。
5. **[ViewModel] `login(refreshToken)`**: 向后端验证。
6. **成功**: 执行 **[登录完成处理]**。
7. **失败**: `updateToAuthenticationFailed()` -> `userState` -> `AuthenticationFailed` (携带网络或认证错误标志)。

### 3.2 手动登录流程
1. **[UI] `login(uname, pwd)`**: 用户提交表单。
2. **[Repository] `updateToAuthenticating()`**: `userState` -> `Authenticating`。
3. **[API] `LoginApi.login()`**: 异步网络请求。
4. **[登录完成处理]**:
   - **持久化**: `GlobalCredentialProvider.storage.saveUserInfo(response)`。
   - **内存态**: 更新全局令牌 (Token, UserId, CompanyId)。
   - **分发**: `loginStateManager.setLoggedIn(response)`。
   - **状态**: `userRepository.updateToAuthenticated(response)` -> `userState` -> `Authenticated`。

### 3.3 登出流程 (Logout)
1. **[ViewModel] `logout()`**:
2. **[Repository] `updateToLoggingOut()`**: `userState` -> `LoggingOut`。
3. **[Manager] `loginStateManager.setLoggingOut()`**: 通知各模块停止工作。
4. **[Storage] `clearUserInfo()`**: 彻底删除本地持久化凭据。
5. **[Manager] `loginStateManager.setLoggedOut()`**: 确认完全登出。
6. **[Repository] `updateToLoggedOut()`**: `userState` -> `Idle` (UI 自动导向登录)。

## 4. 关键细节分析

### 4.1 状态枚举 (LoginState)
```kotlin
sealed class LoginState {
    object Idle                  // 初始/未登录
    object Checking              // 启动时检查本地文件
    object Authenticating        // 请求服务器中
    data class Authenticated(val userInfo: UserInfo) // 成功
    data class AuthenticationFailed(val error: String, val isNetworkError: Boolean) // 失败 (区分网络/凭证过期)
    object LoggingOut            // 登出处理中
}
```

### 4.2 路由分发逻辑
`LoginStateManager` 维护一个 `listeners` 集合。
- **[OnLogin]**: `UserDataSyncListener` 将用户信息同步到 SQLite `User` 表，确保跨会话的离线用户数据可用。
- **[OnLogin]**: TCP 模块 (如 `SenderSdk`) 收到通知后建立长连接通道。

### 4.3 错误处理逻辑
- **401 Unauthorized**: 自动触发 `clearUserInfo()` 并通知 UI 跳转登录页，防止凭据过期导致的死循环。
- **网络错误**: `isNetworkError` 标记为 `true`，UI 会显示 "重试" 按钮而不是强制重新登录。

## 5. 常见问题排查 (Troubleshooting)
- **UI 不跳转**: 检查 `ChatMainScreen` 是否正确收集了 `userRepository.userState`。
- **自动登录失效**: 确认 `refreshToken` 是否在 `GlobalCredentialProvider.storage` 中正确持久化。
- **本地用户丢失**: 检查 `UserRepository.addOrUpdateUser` 是否在事务中正确执行。

# 简化版 Kubernetes 部署文件 - 适用于 k3s 单节点环境
---
# PostgreSQL 部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-db
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-db
  template:
    metadata:
      labels:
        app: postgres-db
    spec:
      containers:
      - name: postgres
        image: postgres:14.13
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "group"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          value: "postgres"
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: postgres-storage
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-service
  namespace: default
spec:
  selector:
    app: postgres-db
  ports:
  - protocol: TCP
    port: 5432
    targetPort: 5432
  type: ClusterIP
---
# Redis 部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-cache
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis-cache
  template:
    metadata:
      labels:
        app: redis-cache
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        command:
        - redis-server
        - --appendonly
        - "yes"
        volumeMounts:
        - name: redis-storage
          mountPath: /data
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5
        livenessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
      - name: redis-storage
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: redis-service
  namespace: default
spec:
  selector:
    app: redis-cache
  ports:
  - protocol: TCP
    port: 6379
    targetPort: 6379
  type: ClusterIP
---
# OpenLDAP 部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openldap
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openldap
  template:
    metadata:
      labels:
        app: openldap
    spec:
      containers:
      - name: openldap
        image: osixia/openldap:1.5.0
        ports:
        - containerPort: 389
        - containerPort: 636
        env:
        - name: LDAP_ORGANISATION
          value: "MyCompany"
        - name: LDAP_DOMAIN
          value: "mycompany.com"
        - name: LDAP_ADMIN_PASSWORD
          value: "admin"
        - name: LDAP_CONFIG_PASSWORD
          value: "config"
        - name: LDAP_READONLY_USER
          value: "false"
        - name: LDAP_REMOVE_CONFIG_AFTER_SETUP
          value: "true"
        - name: LDAP_SSL_HELPER_PREFIX
          value: "ldap"
        volumeMounts:
        - name: ldap-data
          mountPath: /var/lib/ldap
        - name: ldap-config
          mountPath: /etc/ldap/slapd.d
        readinessProbe:
          exec:
            command:
            - ldapsearch
            - -x
            - -H
            - ldap://localhost
            - -b
            - dc=mycompany,dc=com
            - -D
            - cn=admin,dc=mycompany,dc=com
            - -w
            - admin
          initialDelaySeconds: 15
          periodSeconds: 10
        livenessProbe:
          exec:
            command:
            - ldapsearch
            - -x
            - -H
            - ldap://localhost
            - -b
            - dc=mycompany,dc=com
            - -D
            - cn=admin,dc=mycompany,dc=com
            - -w
            - admin
          initialDelaySeconds: 30
          periodSeconds: 30
      volumes:
      - name: ldap-data
        emptyDir: {}
      - name: ldap-config
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: openldap-service
  namespace: default
spec:
  selector:
    app: openldap
  ports:
  - protocol: TCP
    port: 389
    targetPort: 389
  - protocol: TCP
    port: 636
    targetPort: 636
  type: ClusterIP
---
# phpLDAPadmin 部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: phpldapadmin
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: phpldapadmin
  template:
    metadata:
      labels:
        app: phpldapadmin
    spec:
      containers:
      - name: phpldapadmin
        image: dinkel/phpldapadmin
        ports:
        - containerPort: 80
        env:
        - name: LDAP_SERVER_HOST
          value: "openldap-service.default.svc.cluster.local"
        - name: LDAP_SERVER_PORT
          value: "389"
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: phpldapadmin-service
  namespace: default
spec:
  selector:
    app: phpldapadmin
  ports:
  - protocol: TCP
    port: 8085
    targetPort: 80
  type: NodePort
---
# IM Server 部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: im-server
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: im-server
  template:
    metadata:
      labels:
        app: im-server
    spec:
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.35
        command: ['sh', '-c', 'until nc -z postgres-service 5432; do echo waiting for postgres; sleep 2; done']
      - name: wait-for-redis
        image: busybox:1.35
        command: ['sh', '-c', 'until nc -z redis-service 6379; do echo waiting for redis; sleep 2; done']
      - name: wait-for-openldap
        image: busybox:1.35
        command: ['sh', '-c', 'until nc -z openldap-service 389; do echo waiting for openldap; sleep 2; done']
      containers:
      - name: im-server
        image: im-server:latest  # Build this from your Dockerfile
        ports:
        - containerPort: 8080
        - containerPort: 8088
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:postgresql://postgres-service:5432/group"
        - name: SPRING_DATASOURCE_USERNAME
          value: "postgres"
        - name: SPRING_DATASOURCE_PASSWORD
          value: "postgres"
        - name: SPRING_DATA_REDIS_HOST
          value: "redis-service"
        - name: SPRING_DATA_REDIS_PORT
          value: "6379"
        - name: SPRING_LDAP_URLS
          value: "ldap://openldap-service:389"
        - name: SPRING_LDAP_USERNAME
          value: "cn=admin,dc=mycompany,dc=com"
        - name: SPRING_LDAP_PASSWORD
          value: "admin"
        - name: SPRING_LDAP_BASE
          value: "dc=mycompany,dc=com"
        - name: SYSTEM_INITIALIZER_ENABLED
          value: "true"
        - name: DEFAULT_COMPANY_NAME
          value: "public"
        - name: DEFAULT_COMPANY_SCHEMA
          value: "public"
        - name: DEFAULT_COMPANY_ACTIVE
          value: "true"
        - name: ADMIN_USERNAME
          value: "admin"
        - name: ADMIN_EMAIL
          value: "admin@example.com"
        - name: ADMIN_PHONE_NUMBER
          value: "1234567890"
        - name: ADMIN_PASSWORD
          value: "12345"
        - name: TCP_PORT
          value: "8088"
        - name: WEBRTC_SESSION_TIMEOUT
          value: "300000"
        - name: JAVA_OPTS
          value: "-Xmx2g -Xms1g -XX:+UseG1GC"
        volumeMounts:
        - name: logs-volume
          mountPath: /app/logs
        - name: storage-volume
          mountPath: /app/storage
        - name: tmp-volume
          mountPath: /tmp
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
      volumes:
      - name: logs-volume
        emptyDir: {}
      - name: storage-volume
        emptyDir: {}
      - name: tmp-volume
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: im-server-service
  namespace: default
spec:
  selector:
    app: im-server
  ports:
  - name: http
    protocol: TCP
    port: 8080
    targetPort: 8080
  - name: tcp
    protocol: TCP
    port: 8088
    targetPort: 8088
  type: NodePort
---
# Nginx 部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-proxy
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-proxy
  template:
    metadata:
      labels:
        app: nginx-proxy
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        - containerPort: 443
        - containerPort: 8088
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: nginx-tcp-config
          mountPath: /etc/nginx/stream.conf.d/tcp-proxy.conf
          subPath: tcp-proxy.conf
        - name: ssl-certs
          mountPath: /etc/nginx/ssl
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-configmap
      - name: nginx-tcp-config
        configMap:
          name: nginx-tcp-configmap
      - name: ssl-certs
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: default
spec:
  selector:
    app: nginx-proxy
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80
  - name: https
    protocol: TCP
    port: 443
    targetPort: 443
  - name: tcp-im
    protocol: TCP
    port: 8088
    targetPort: 8088
  type: NodePort
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-configmap
  namespace: default
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 1024;
        use epoll;
        multi_accept on;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                       '$status $body_bytes_sent "$http_referer" '
                       '"$http_user_agent" "$http_x_forwarded_for"';
        
        access_log /var/log/nginx/access.log main;
        
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/json
            application/javascript
            application/xml+rss
            application/atom+xml
            image/svg+xml;
        
        upstream app_server {
            server im-server-service:8080 weight=1 max_fails=2 fail_timeout=30s;
        }
        
        server {
            listen 80;
            server_name _;
            
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header Referrer-Policy "no-referrer-when-downgrade" always;
            
            client_max_body_size 100M;
            
            location /ws {
                proxy_pass http://app_server;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
                
                proxy_read_timeout 86400;
                proxy_send_timeout 86400;
            }
            
            location /api {
                proxy_pass http://app_server;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }
            
            location /static {
                proxy_pass http://app_server;
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
            
            location /actuator/health {
                proxy_pass http://app_server;
                access_log off;
            }
            
            location / {
                proxy_pass http://app_server;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }
        }
        
        server {
            listen 443 ssl http2;
            server_name _;
            
            ssl_certificate /etc/nginx/ssl/cert.pem;
            ssl_certificate_key /etc/nginx/ssl/key.pem;
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
            ssl_prefer_server_ciphers off;
            
            add_header Strict-Transport-Security "max-age=63072000" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header Referrer-Policy "no-referrer-when-downgrade" always;
            
            client_max_body_size 100M;
            
            location /ws {
                proxy_pass http://app_server;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
                
                proxy_read_timeout 86400;
                proxy_send_timeout 86400;
            }
            
            location /api {
                proxy_pass http://app_server;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }
            
            location /static {
                proxy_pass http://app_server;
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
            
            location /actuator/health {
                proxy_pass http://app_server;
                access_log off;
            }
            
            location / {
                proxy_pass http://app_server;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }
        }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-tcp-configmap
  namespace: default
data:
  tcp-proxy.conf: |
    upstream tcp_backend {
        server im-server-service:8088 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 8088 so_keepalive=on;
        proxy_pass tcp_backend;
        proxy_timeout 1h;
        proxy_responses 1;
        proxy_connect_timeout 1s;
        
        tcp_nodelay on;
        so_keepalive=on;
        
        proxy_buffer_size 16k;
    }
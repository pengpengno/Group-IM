# Group IM 项目单元测试指南

## 概述

本文档介绍了为Group IM项目编写的单元测试，使用Spock框架进行行为驱动开发(BDD)测试。

## 测试框架和技术栈

- **测试框架**: Spock Framework 2.4-M6
- **语言**: Groovy
- **Mock框架**: Spock内置Mock支持
- **断言**: Spock内置断言机制

## 已编写的测试类

### 1. UserService单元测试 (`UserServiceSpec.groovy`)

位于: `server/src/test/java/com/github/im/server/service/UserServiceSpec.groovy`

#### 测试覆盖的功能

**用户注册相关测试:**
- `测试用户注册成功场景` - 验证正常注册流程
- `测试用户注册时用户名已存在` - 验证重复用户名检测
- `测试用户注册时邮箱已存在` - 验证重复邮箱检测
- `测试用户注册密码不匹配` - 验证密码确认功能

**批量用户注册测试:**
- `测试批量用户注册成功场景` - 验证批量注册功能
- `测试批量用户注册存在重复用户名` - 验证批量注册去重

**用户登录测试:**
- `测试用户登录成功场景` - 验证正常登录流程
- `测试用户登录失败场景` - 验证登录失败处理
- `测试直接数据库验证登录成功` - 验证数据库直接验证

**用户查询测试:**
- `测试根据用户名查询用户成功` - 验证用户名查询
- `测试根据用户ID查询用户成功` - 验证用户ID查询
- `测试根据查询字符串查询用户成功` - 验证模糊查询

**密码重置测试:**
- `测试密码重置成功场景` - 验证密码修改功能
- `测试密码重置用户不存在` - 验证用户存在性检查

**公司相关方法测试:**
- `测试获取所有用户成功` - 验证全量用户查询
- `测试根据公司ID获取用户成功` - 验证按公司查询
- `测试检查用户是否属于指定公司成功/失败` - 验证公司归属检查

### 2. UserController单元测试 (`UserControllerTest.groovy`)

位于: `server/src/test/java/com/github/im/server/controller/UserControllerTest.groovy`

#### 测试覆盖的功能

**REST API接口测试:**
- `测试用户注册接口成功/失败场景` - 验证POST /api/users/register
- `测试获取当前用户公司列表成功/异常场景` - 验证GET /api/users/company/list
- `测试根据用户名查询用户成功/不存在场景` - 验证GET /api/users/{username}
- `测试根据用户ID查询用户成功场景` - 验证GET /api/users/id/{userId}
- `测试根据查询字符串查询用户成功场景` - 验证POST /api/users/query
- `测试用户登录接口成功/失败/空请求场景` - 验证POST /api/users/login
- `测试密码重置接口成功场景` - 验证PUT /api/users/reset-password/{userId}

**异常处理测试:**
- `测试全局异常处理` - 验证统一异常处理机制
- `测试边界条件测试` - 验证极端情况处理

## 测试运行方法

### 方法一：使用Maven命令行

```bash
# 运行所有测试
mvn test

# 运行特定测试类
mvn test -Dtest=UserServiceSpec
mvn test -Dtest=UserControllerTest

# 在server模块中运行测试
mvn test -pl server

# 生成测试覆盖率报告
mvn test jacoco:report
```

### 方法二：使用IDE

在IntelliJ IDEA中：
1. 右键点击测试类文件
2. 选择"Run 'UserServiceSpec'"或"Run 'UserControllerTest'"
3. 查看测试结果和覆盖率

### 方法三：持续集成

```bash
# 清理并运行测试
mvn clean test

# 运行测试并生成报告
mvn clean test jacoco:report
```

## 测试最佳实践

### 1. 测试命名规范
- 使用中文描述测试场景
- 遵循"测试[功能]_[场景]"的命名格式
- 清晰表达测试意图

### 2. 测试结构
每个测试方法遵循Spock的BDD结构：
```groovy
def "测试描述"() {
    given: "准备测试数据和环境"
    // 测试前置条件
    
    when: "执行被测试的方法"
    // 调用被测试代码
    
    then: "验证结果和行为"
    // 验证期望结果和交互
}
```

### 3. Mock使用原则
- 只Mock外部依赖
- 验证重要的方法调用次数
- 使用具体的数据而非通配符

### 4. 测试覆盖范围
- 正常流程测试
- 异常场景测试
- 边界条件测试
- 安全性测试

## 测试质量指标

### 覆盖率目标
- **行覆盖率**: ≥ 80%
- **分支覆盖率**: ≥ 75%
- **方法覆盖率**: ≥ 85%

### 测试特性
- **独立性**: 每个测试相互独立
- **可重复性**: 多次运行结果一致
- **快速性**: 单个测试执行时间 < 1秒
- **清晰性**: 测试名称和结构易于理解

## 常见问题解决

### 1. 测试编译错误
```bash
# 清理并重新编译
mvn clean compile test-compile
```

### 2. 依赖注入问题
确保测试类正确初始化被测试对象和服务依赖。

### 3. Mock交互验证失败
检查Mock对象的方法调用次数和参数是否匹配。

## 扩展建议

### 1. 添加更多测试场景
- 集成测试
- 性能测试
- 安全测试
- 数据库测试

### 2. 完善测试工具链
- 添加测试数据工厂
- 集成CI/CD流水线
- 配置测试环境管理

### 3. 提升测试质量
- 定期审查测试代码
- 重构重复测试逻辑
- 优化测试执行速度

---
*最后更新: 2026年2月*